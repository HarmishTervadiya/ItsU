// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// --- ENUMS ---
enum AccountStatus {
  ACTIVE
  DELETED
}

enum Currency {
  SOL
  SKR
}

enum MatchStatus {
  ONGOING
  FINISHED
  CANCELLED
  SERVER_ERROR
}

enum Role {
  WOLF
  CITIZEN
  PENDING
}

enum TransactionType {
  DEPOSIT_STANDARD
  DEPOSIT_PREMIUM
  PAYOUT
  REFUND
}

enum TransactionStatus {
  PENDING
  CONFIRMED
  FAILED
}

// --- CONFIGURATION ---
model SystemConfig {
  id                String   @id @default("global") // Only one row ever exists
  platformFeePct    Float    @default(5.0) // 5%
  premiumWolfFeeAmt BigInt // The extra raw amount required to queue as Wolf
  matchTimeoutSecs  Int      @default(120) // 2 minutes before AI bots fill
  updatedAt         DateTime @updatedAt
}

model User {
  id            String  @id @default(uuid())
  walletAddress String  @unique
  nonce         String  @default(uuid()) // For SIWS cryptographic verification
  name          String?
  email         String?
  priorityScore Int     @default(0)

  totalSolWon BigInt @default(0)
  totalSkrWon BigInt @default(0)

  gamesPlayed  GamePlayer[]
  transactions Transaction[]

  refreshToken String?
  status       AccountStatus @default(ACTIVE)
  timezone     String        @default("UTC")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@unique([walletAddress, status])
}

model QueueEntry {
  id       String   @id @default(uuid())
  userId   String   @unique
  currency Currency
  intent   Role // What did they pay for? WOLF or CITIZEN
  joinedAt DateTime @default(now())
}

model Game {
  id          String      @id @default(uuid())
  status      MatchStatus @default(ONGOING)
  currency    Currency
  potAmount   BigInt
  winnerRole  Role?
  itemName    String
  hint        String
  timeLimit   Int
  totalRounds Int         @default(0)

  startTime DateTime  @default(now())
  endTime   DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // relations
  players      GamePlayer[]
  transactions Transaction[]
  item         Item          @relation(fields: [itemId], references: [id])
  itemId       String
}

model Item {
  id       String   @id @default(uuid())
  name     String
  category String?
  hints    String[]
  isActive Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // relations
  games Game[]
}

model GamePlayer {
  id     String @id @default(uuid())
  gameId String
  userId String

  role           Role
  isDead         Boolean @default(false)
  roundsSurvived Int     @default(0)
  winnings       BigInt  @default(0)

  game      Game     @relation(fields: [gameId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([gameId, userId])
}

model Transaction {
  id          String  @id @default(uuid())
  txSignature String? @unique
  reference   String  @unique
  gameId      String?
  userId      String

  type     TransactionType
  currency Currency
  amount   BigInt
  status   TransactionStatus @default(PENDING)

  user User  @relation(fields: [userId], references: [id])
  game Game? @relation(fields: [gameId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
